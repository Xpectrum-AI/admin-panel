name: Deploy to Release

on:
  workflow_dispatch:
    inputs:
      image_tag_suffix:
        description: "Image tag suffix (e.g., 2025w01)"
        required: false
        type: string
  push:
    branches:
      - "release-*"

env:
  DIGITALOCEAN_REGION: sfo3

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Lint frontend
        run: |
          cd frontend
          npm run lint || echo "Lint completed with warnings"

      - name: Type check frontend
        run: |
          cd frontend
          npx tsc --noEmit || echo "Type check completed with warnings"

      - name: Run tests
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false

  deploy-release:
    runs-on: ubuntu-latest
    environment: release
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js for Pulumi
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Login to DigitalOcean Container Registry
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Authenticate Docker with DOCR
        run: |
          doctl registry login --expiry-seconds 1200

      - name: Generate image tag for Admin Panel with date and counter
        id: admin-image-tag
        run: |
          # Get today's date in YYYY-MM-DD format
          TODAY=$(date +%Y-%m-%d)
          
          # Full repository path
          REPO="registry.digitalocean.com/xpectrum-main-app-dev/admin-release"
          REPO_NAME="xpectrum-main-app-dev/admin-release"
          
          # Tag prefix for today
          TAG_PREFIX="admin-release-${TODAY}"
          
          echo "Today's date: $TODAY"
          echo "Tag prefix: $TAG_PREFIX"
          
          # Find the highest counter for today's date by checking existing tags
          MAX_COUNTER=0
          FOUND_TAGS=false
          
          # Method 1: Try to get tags using doctl
          if command -v doctl >/dev/null 2>&1; then
            EXISTING_TAGS=$(doctl registry repository list-tags $REPO_NAME --format Tag --no-header 2>/dev/null || echo "")
            if [ -n "$EXISTING_TAGS" ]; then
              echo "Querying existing tags via doctl..."
              for tag in $EXISTING_TAGS; do
                if [[ $tag == ${TAG_PREFIX}-* ]]; then
                  FOUND_TAGS=true
                  # Extract the counter part (3 digits after the last dash)
                  COUNTER=$(echo $tag | sed "s/${TAG_PREFIX}-//" | sed 's/^0*//')
                  if [ -z "$COUNTER" ]; then
                    COUNTER=0
                  fi
                  # Convert to integer and find max
                  if [ "$COUNTER" -gt "$MAX_COUNTER" ] 2>/dev/null; then
                    MAX_COUNTER=$COUNTER
                  fi
                fi
              done
            fi
          fi
          
          # Method 2: Fallback - use docker manifest inspect if doctl didn't find matching tags
          if [ "$FOUND_TAGS" = false ]; then
            echo "Using docker manifest inspect fallback to find existing tags..."
            for i in {1..999}; do
              COUNTER_FORMATTED=$(printf "%03d" $i)
              TEST_TAG="${TAG_PREFIX}-${COUNTER_FORMATTED}"
              if docker manifest inspect "$REPO:$TEST_TAG" >/dev/null 2>&1; then
                MAX_COUNTER=$i
                echo "Found existing tag: $TEST_TAG"
              else
                break
              fi
            done
          fi
          
          # Increment counter and format with leading zeros
          NEW_COUNTER=$((MAX_COUNTER + 1))
          FORMATTED_COUNTER=$(printf "%03d" $NEW_COUNTER)
          
          # Generate the final tag
          IMAGE_TAG="${TAG_PREFIX}-${FORMATTED_COUNTER}"
          
          echo "Max existing counter: $MAX_COUNTER"
          echo "New counter: $NEW_COUNTER"
          echo "Generated tag: $IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Generate image tag for Developer Dashboard with date and counter
        id: developer-image-tag
        run: |
          # Get today's date in YYYY-MM-DD format
          TODAY=$(date +%Y-%m-%d)
          
          # Full repository path
          REPO="registry.digitalocean.com/xpectrum-main-app-dev/developer-release"
          REPO_NAME="xpectrum-main-app-dev/developer-release"
          
          # Tag prefix for today
          TAG_PREFIX="developer-release-${TODAY}"
          
          echo "Today's date: $TODAY"
          echo "Tag prefix: $TAG_PREFIX"
          
          # Find the highest counter for today's date by checking existing tags
          MAX_COUNTER=0
          FOUND_TAGS=false
          
          # Method 1: Try to get tags using doctl
          if command -v doctl >/dev/null 2>&1; then
            EXISTING_TAGS=$(doctl registry repository list-tags $REPO_NAME --format Tag --no-header 2>/dev/null || echo "")
            if [ -n "$EXISTING_TAGS" ]; then
              echo "Querying existing tags via doctl..."
              for tag in $EXISTING_TAGS; do
                if [[ $tag == ${TAG_PREFIX}-* ]]; then
                  FOUND_TAGS=true
                  # Extract the counter part (3 digits after the last dash)
                  COUNTER=$(echo $tag | sed "s/${TAG_PREFIX}-//" | sed 's/^0*//')
                  if [ -z "$COUNTER" ]; then
                    COUNTER=0
                  fi
                  # Convert to integer and find max
                  if [ "$COUNTER" -gt "$MAX_COUNTER" ] 2>/dev/null; then
                    MAX_COUNTER=$COUNTER
                  fi
                fi
              done
            fi
          fi
          
          # Method 2: Fallback - use docker manifest inspect if doctl didn't find matching tags
          if [ "$FOUND_TAGS" = false ]; then
            echo "Using docker manifest inspect fallback to find existing tags..."
            for i in {1..999}; do
              COUNTER_FORMATTED=$(printf "%03d" $i)
              TEST_TAG="${TAG_PREFIX}-${COUNTER_FORMATTED}"
              if docker manifest inspect "$REPO:$TEST_TAG" >/dev/null 2>&1; then
                MAX_COUNTER=$i
                echo "Found existing tag: $TEST_TAG"
              else
                break
              fi
            done
          fi
          
          # Increment counter and format with leading zeros
          NEW_COUNTER=$((MAX_COUNTER + 1))
          FORMATTED_COUNTER=$(printf "%03d" $NEW_COUNTER)
          
          # Generate the final tag
          IMAGE_TAG="${TAG_PREFIX}-${FORMATTED_COUNTER}"
          
          echo "Max existing counter: $MAX_COUNTER"
          echo "New counter: $NEW_COUNTER"
          echo "Generated tag: $IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Build and push Main Frontend image to DOCR
        env:
          # Non-sensitive build-time variables only (secrets injected at runtime)
          NEXT_PUBLIC_LIVE_API_URL: ${{ vars.REL_LIVE_API_URL }}
          NEXT_PUBLIC_PROPELAUTH_URL: ${{ vars.REL_PROPELAUTH_URL }}
          NEXT_PUBLIC_SUPER_ADMIN_ORG_ID: ${{ secrets.REL_SUPER_ADMIN_ORG_ID }}
        run: |
          # Use the specific registry name
          REPO="registry.digitalocean.com/xpectrum-main-app-dev/admin-release"
          IMAGE_TAG="${{ steps.admin-image-tag.outputs.image_tag }}"
          
          echo "Building and pushing Admin Panel image with tag: $IMAGE_TAG"
          echo "Note: Secrets are injected at runtime via Digital Ocean App Platform"

          # Build, tag, and push main frontend with non-sensitive build-time variables only
          cd frontend
          docker build \
            --build-arg NEXT_PUBLIC_LIVE_API_URL="${NEXT_PUBLIC_LIVE_API_URL}" \
            --build-arg NEXT_PUBLIC_PROPELAUTH_URL="${NEXT_PUBLIC_PROPELAUTH_URL}" \
            --build-arg NEXT_PUBLIC_SUPER_ADMIN_ORG_ID="${NEXT_PUBLIC_SUPER_ADMIN_ORG_ID}" \
            -t admin-panel-release:$IMAGE_TAG .
          
          docker tag admin-panel-release:$IMAGE_TAG $REPO:$IMAGE_TAG
          docker push $REPO:$IMAGE_TAG
          
          # Also tag as latest for convenience
          docker tag admin-panel-release:$IMAGE_TAG $REPO:latest
          docker push $REPO:latest
          
          echo "âœ… Admin Panel image pushed with tag: $IMAGE_TAG"
          cd ..

      - name: Build and push Developer Frontend image to DOCR
        env:
          # Non-sensitive build-time variables only (secrets injected at runtime)
          NEXT_PUBLIC_LIVE_API_URL: ${{ vars.REL_LIVE_API_URL }}
          NEXT_PUBLIC_DEVELOPMENT_PROPELAUTH_URL: ${{ vars.REL_DEVELOPER_PROPELAUTH_URL }}
          NEXT_PUBLIC_SUPER_ADMIN_ORG_ID: ${{ secrets.REL_SUPER_ADMIN_ORG_ID }}
          NEXT_PUBLIC_MODEL_API_BASE_URL: ${{ vars.REL_MODEL_API_BASE_URL }}
          NEXT_PUBLIC_CHATBOT_API_URL: ${{ vars.REL_CHATBOT_API_URL }}
          NEXT_PUBLIC_CARTESIA_VOICE_ID: ${{ vars.REL_CARTESIA_VOICE_ID }}
          NEXT_PUBLIC_ELEVEN_LABS_VOICE_ID: ${{ vars.REL_ELEVEN_LABS_VOICE_ID }}
          NEXT_PUBLIC_DIFY_CONSOLE_ORIGIN: ${{ vars.REL_DIFY_CONSOLE_ORIGIN }}
          NEXT_PUBLIC_DIFY_ADMIN_EMAIL: ${{ vars.REL_DIFY_ADMIN_EMAIL }}
          NEXT_PUBLIC_DIFY_WORKSPACE_ID: ${{ vars.REL_DIFY_WORKSPACE_ID }}
          NEXT_PUBLIC_DIFY_BASE_URL: ${{ vars.REL_DIFY_BASE_URL }}
        run: |
          # Use the specific registry name
          REPO="registry.digitalocean.com/xpectrum-main-app-dev/developer-release"
          IMAGE_TAG="${{ steps.developer-image-tag.outputs.image_tag }}"
          
          echo "Building and pushing Developer Dashboard image with tag: $IMAGE_TAG"
          echo "Note: Secrets are injected at runtime via Digital Ocean App Platform"

          # Build, tag, and push developer frontend with non-sensitive build-time variables only
          cd frontend-developer
          docker build \
            --no-cache \
            --build-arg NEXT_PUBLIC_LIVE_API_URL="${NEXT_PUBLIC_LIVE_API_URL}" \
            --build-arg NEXT_PUBLIC_DEVELOPMENT_PROPELAUTH_URL="${NEXT_PUBLIC_DEVELOPMENT_PROPELAUTH_URL}" \
            --build-arg NEXT_PUBLIC_SUPER_ADMIN_ORG_ID="${NEXT_PUBLIC_SUPER_ADMIN_ORG_ID}" \
            --build-arg NEXT_PUBLIC_MODEL_API_BASE_URL="${NEXT_PUBLIC_MODEL_API_BASE_URL}" \
            --build-arg NEXT_PUBLIC_CHATBOT_API_URL="${NEXT_PUBLIC_CHATBOT_API_URL}" \
            --build-arg NEXT_PUBLIC_CARTESIA_VOICE_ID="${NEXT_PUBLIC_CARTESIA_VOICE_ID}" \
            --build-arg NEXT_PUBLIC_ELEVEN_LABS_VOICE_ID="${NEXT_PUBLIC_ELEVEN_LABS_VOICE_ID}" \
            --build-arg NEXT_PUBLIC_DIFY_CONSOLE_ORIGIN="${NEXT_PUBLIC_DIFY_CONSOLE_ORIGIN}" \
            --build-arg NEXT_PUBLIC_DIFY_ADMIN_EMAIL="${NEXT_PUBLIC_DIFY_ADMIN_EMAIL}" \
            --build-arg NEXT_PUBLIC_DIFY_WORKSPACE_ID="${NEXT_PUBLIC_DIFY_WORKSPACE_ID}" \
            --build-arg NEXT_PUBLIC_DIFY_BASE_URL="${NEXT_PUBLIC_DIFY_BASE_URL}" \
            -t developer-dashboard-release:$IMAGE_TAG .
          
          docker tag developer-dashboard-release:$IMAGE_TAG $REPO:$IMAGE_TAG
          docker push $REPO:$IMAGE_TAG
          
          # Also tag as latest for convenience
          docker tag developer-dashboard-release:$IMAGE_TAG $REPO:latest
          docker push $REPO:latest
          
          echo "âœ… Developer Dashboard image pushed with tag: $IMAGE_TAG"
          cd ..

      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
        with:
          pulumi-version: latest

      - name: Install Pulumi dependencies
        run: |
          cd digital-ocean-deployment
          npm ci

      - name: Check and create Pulumi stack if needed
        working-directory: digital-ocean-deployment
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          # Check if stack exists, if not create it
          if pulumi stack select frontend-release 2>/dev/null; then
            echo "âœ… Stack 'frontend-release' already exists, using it"
          else
            echo "ðŸ“¦ Stack 'frontend-release' does not exist, creating it..."
            pulumi stack init frontend-release
            echo "âœ… Stack 'frontend-release' created successfully"
          fi

      - name: Configure Pulumi from GitHub secrets
        working-directory: digital-ocean-deployment
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          # Select the stack (required before setting config)
          pulumi stack select frontend-release
          
          # Set DigitalOcean token (required - from GitHub secret)
          pulumi config set digitalocean:token $DIGITALOCEAN_TOKEN --secret
          
          # Set region (required - from env variable)
          pulumi config set index:region ${{ env.DIGITALOCEAN_REGION }}
          
          # Admin Panel and Developer Dashboard share the same namespace (release:)
          # Both use the same propelauthApiKey and propelauthUrl config keys
          # Using Developer Dashboard values since they're more specific
          pulumi config set release:propelauthApiKey "${{ secrets.REL_PROPELAUTH_API_KEY }}" --secret
          pulumi config set release:liveApiKey "${{ secrets.REL_LIVE_API_KEY }}" --secret
          pulumi config set release:propelauthUrl "${{ vars.REL_DEVELOPER_PROPELAUTH_URL }}"
          pulumi config set release:liveApiUrl "${{ vars.REL_LIVE_API_URL }}"
          pulumi config set release:superAdminOrgId "${{ secrets.REL_SUPER_ADMIN_ORG_ID }}"
          
          # Developer Dashboard secrets - using REL_* secrets, storing in release: namespace
          pulumi config set release:difyAdminPassword "${{ secrets.REL_DIFY_ADMIN_PASSWORD }}" --secret
          pulumi config set release:chatbotApiKey "${{ secrets.REL_CHATBOT_API_KEY }}" --secret
          pulumi config set release:elevenLabsApiKey "${{ secrets.REL_ELEVEN_LABS_API_KEY }}" --secret
          pulumi config set release:openAiApiKey "${{ secrets.REL_OPEN_AI_API_KEY }}" --secret
          pulumi config set release:whisperApiKey "${{ secrets.REL_WHISPER_API_KEY }}" --secret
          pulumi config set release:deepgramApiKey "${{ secrets.REL_DEEPGRAM_API_KEY }}" --secret
          pulumi config set release:cartesiaApiKey "${{ secrets.REL_CARTESIA_API_KEY }}" --secret
          
          # Developer Dashboard config values - using REL_* vars, storing in release: namespace
          # Note: propelauthUrl already set above (shared with Admin Panel)
          pulumi config set release:apiBaseUrl "${{ vars.REL_MODEL_API_BASE_URL }}"
          pulumi config set release:enableEmailVerification "true"
          pulumi config set release:difyConsoleOrigin "${{ vars.REL_DIFY_CONSOLE_ORIGIN }}"
          pulumi config set release:difyAdminEmail "${{ vars.REL_DIFY_ADMIN_EMAIL }}"
          pulumi config set release:difyWorkspaceId "${{ vars.REL_DIFY_WORKSPACE_ID }}"
          pulumi config set release:difyBaseUrl "${{ vars.REL_DIFY_BASE_URL }}"
          pulumi config set release:chatbotApiUrl "${{ vars.REL_CHATBOT_API_URL }}"
          pulumi config set release:cartesiaVoiceId "${{ vars.REL_CARTESIA_VOICE_ID }}"
          pulumi config set release:elevenLabsVoiceId "${{ vars.REL_ELEVEN_LABS_VOICE_ID }}"
          pulumi config set release:liveApiUrl "${{ vars.REL_LIVE_API_URL }}"
          pulumi config set release:imagekitPublicKey "${{ vars.REL_IMAGEKIT_PUBLIC_KEY }}"
          pulumi config set release:imagekitUrlEndpoint "${{ vars.REL_IMAGEKIT_URL_ENDPOINT }}"
          pulumi config set release:imagekitPrivateKey "${{ secrets.REL_IMAGEKIT_PRIVATE_KEY }}" --secret
          pulumi config set release:demoJwtSecret "${{ secrets.REL_DEMO_JWT_SECRET }}" --secret
          
          # Set image tags (from generated tags)
          pulumi config set release:adminImageTag "${{ steps.admin-image-tag.outputs.image_tag }}"
          pulumi config set release:developerImageTag "${{ steps.developer-image-tag.outputs.image_tag }}"
          
          echo "âœ… Pulumi config fully configured from GitHub secrets and variables"

      - name: Deploy with Pulumi
        working-directory: digital-ocean-deployment
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          # Select the stack
          pulumi stack select frontend-release
          
          # Deploy updates
          pulumi up --yes

      - name: Get deployment URLs
        id: pulumi-outputs
        working-directory: digital-ocean-deployment
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          pulumi stack select frontend-release
          ADMIN_URL=$(pulumi stack output adminPanelUrl 2>/dev/null || echo "")
          DEVELOPER_URL=$(pulumi stack output developerDashboardUrl 2>/dev/null || echo "")
          
          echo "admin-url=$ADMIN_URL" >> $GITHUB_OUTPUT
          echo "developer-url=$DEVELOPER_URL" >> $GITHUB_OUTPUT
          
          echo "Admin Panel URL: $ADMIN_URL"
          echo "Developer Dashboard URL: $DEVELOPER_URL"

      - name: Wait for apps to be ready
        run: |
          echo "Waiting for DigitalOcean apps to be ready..."
          sleep 90

      - name: Health check
        run: |
          ADMIN_URL="${{ steps.pulumi-outputs.outputs.admin-url }}"
          DEVELOPER_URL="${{ steps.pulumi-outputs.outputs.developer-url }}"
          
          if [ -z "$ADMIN_URL" ] || [ "$ADMIN_URL" = "" ]; then
            echo "Warning: Could not get Admin Panel URL from Pulumi outputs"
            ADMIN_URL="https://admin-release.xpectrum-ai.com"
          fi
          
          if [ -z "$DEVELOPER_URL" ] || [ "$DEVELOPER_URL" = "" ]; then
            echo "Warning: Could not get Developer Dashboard URL from Pulumi outputs"
            DEVELOPER_URL="https://developer-release.xpectrum-ai.com"
          fi
          
          echo "Testing Admin Panel health endpoints on: $ADMIN_URL"
          echo "Testing Developer Dashboard health endpoints on: $DEVELOPER_URL"
          
          # Health checks for Admin Panel
          curl -f -k "$ADMIN_URL/" || echo "Admin Panel root endpoint check failed"
          curl -f -k "$ADMIN_URL/api/health" || echo "Admin Panel health endpoint check failed"
          
          # Health checks for Developer Dashboard
          curl -f -k "$DEVELOPER_URL/" || echo "Developer Dashboard root endpoint check failed"
          curl -f -k "$DEVELOPER_URL/api/health" || echo "Developer Dashboard health endpoint check failed"
          
          echo "Health checks completed"

      - name: Generate deployment summary
        run: |
          ADMIN_TAG="${{ steps.admin-image-tag.outputs.image_tag }}"
          DEVELOPER_TAG="${{ steps.developer-image-tag.outputs.image_tag }}"
          ADMIN_REPO="registry.digitalocean.com/xpectrum-main-app-dev/admin-release"
          DEVELOPER_REPO="registry.digitalocean.com/xpectrum-main-app-dev/developer-release"
          ADMIN_FULL_IMAGE="${ADMIN_REPO}:${ADMIN_TAG}"
          DEVELOPER_FULL_IMAGE="${DEVELOPER_REPO}:${DEVELOPER_TAG}"
          
          echo "ðŸŽ‰ Release Deployment Complete!"
          echo "ðŸ“¦ Admin Panel Image: $ADMIN_FULL_IMAGE"
          echo "ðŸ“¦ Developer Dashboard Image: $DEVELOPER_FULL_IMAGE"
          echo "ðŸŒ Environment: release"
          echo "ðŸ”§ Stack: frontend-release"
          echo "ðŸ·ï¸  Admin Panel Tag: $ADMIN_TAG"
          echo "ðŸ·ï¸  Developer Dashboard Tag: $DEVELOPER_TAG"
          
          # Add to GitHub Actions summary
          echo "## ðŸš€ Release Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Admin Panel" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`$ADMIN_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Developer Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: \`$DEVELOPER_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Œ For Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "Use these image tags when promoting to production:" >> $GITHUB_STEP_SUMMARY
          echo "- Admin Panel: \`$ADMIN_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- Developer Dashboard: \`$DEVELOPER_TAG\`" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Deployment summary generated"

  deployment-failure:
    needs: deploy-release
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Release Deployment Failed
        run: |
          echo "Release deployment failed - check the logs for details"
