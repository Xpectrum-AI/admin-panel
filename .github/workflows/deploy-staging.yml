name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  AWS_REGION: us-west-1
  ACCOUNT_ID: 641623447164

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Frontend image to ECR
      run: |
        # Set ECR repository URI
        REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/admin-panel"
        
        # Build, tag, and push frontend only
        cd frontend
        docker build -t admin-panel:frontend-staging .
        docker tag admin-panel:frontend-staging $REPO:frontend-staging
        docker push $REPO:frontend-staging
        cd ..

    - name: Setup Python for CDK
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install CDK dependencies
      run: |
        cd python-cdk-v2
        pip install -r requirements.txt

    - name: Install AWS CDK
      run: |
        npm install -g aws-cdk

    - name: Deploy CDK stack (staging)
      env:
        # Pass GitHub environment variables to CDK
        STAGING_NEXT_PUBLIC_PROPELAUTH_API_KEY: ${{ secrets.STAGING_NEXT_PUBLIC_PROPELAUTH_API_KEY }}
        STAGING_NEXT_PUBLIC_API_KEY: ${{ secrets.STAGING_NEXT_PUBLIC_API_KEY }}
        STAGING_GOOGLE_CLIENT_ID: ${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
        STAGING_MONGODB_URL: ${{ secrets.STAGING_MONGODB_URL }}
        STAGING_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STAGING_STRIPE_PUBLISHABLE_KEY }}
        STAGING_SECRET_KEY: ${{ secrets.STAGING_SECRET_KEY }}
        STAGING_PROPELAUTH_API_KEY: ${{ secrets.STAGING_PROPELAUTH_API_KEY }}
        STAGING_PROPELAUTH_VERIFIER_KEY: ${{ secrets.STAGING_PROPELAUTH_VERIFIER_KEY }}
        STAGING_PROPELAUTH_REDIRECT_URI: ${{ secrets.STAGING_PROPELAUTH_REDIRECT_URI }}
        STAGING_NEXT_PUBLIC_LIVE_API_URL: ${{ secrets.STAGING_NEXT_PUBLIC_LIVE_API_URL }}
        STAGING_SUPER_ADMIN_ORG_ID: ${{ secrets.STAGING_SUPER_ADMIN_ORG_ID }}
      run: |
        cd python-cdk-v2
        # Deploy to staging environment with staging context
        # Add timeout to prevent hanging
        timeout 30m cdk deploy AdminPanelStagingStack --require-approval never --context environment=staging || {
          echo "CDK deployment timed out or failed"
          echo "Checking ECS service status..."
          aws ecs describe-services \
            --cluster AdminPanelStagingStack-AdminPanelStagingStackCluster354587DC-WMnszSmI30dz \
            --services AdminPanelStagingStack-AdminPanelStagingStackService167ECF01-mGcKXTWR0Ntv \
            --region ${{ env.AWS_REGION }} || echo "Could not check ECS status"
          exit 1
        }

    - name: Wait for deployment to complete
      run: |
        # Check if stack exists first
        if aws cloudformation describe-stacks --stack-name AdminPanelStagingStack --region ${{ env.AWS_REGION }} 2>/dev/null; then
          # Wait for ECS services to be stable
          aws ecs wait services-stable \
            --cluster AdminPanelStagingStack-AdminPanelStagingStackCluster354587DC-WMnszSmI30dz \
            --services AdminPanelStagingStack-AdminPanelStagingStackService167ECF01-mGcKXTWR0Ntv \
            --region ${{ env.AWS_REGION }} || echo "Services not stable yet"
        else
          echo "Stack does not exist yet, skipping wait"
        fi

    - name: Get ALB DNS name
      id: alb-dns
      run: |
        DNS_NAME=$(aws cloudformation describe-stacks \
          --stack-name AdminPanelStagingStack \
          --query 'Stacks[0].Outputs[?OutputKey==`FrontendURL`].OutputValue' \
          --output text \
          --region ${{ env.AWS_REGION }})
        echo "alb-dns=$DNS_NAME" >> $GITHUB_OUTPUT

    - name: Health check
      run: |
        # Wait for services to be fully ready
        sleep 60
        
        # Get ALB DNS name
        DNS_NAME=$(aws cloudformation describe-stacks \
          --stack-name AdminPanelStagingStack \
          --query 'Stacks[0].Outputs[?OutputKey==`FrontendURL`].OutputValue' \
          --output text \
          --region ${{ env.AWS_REGION }})
        
        # Check if DNS_NAME is not empty
        if [ -z "$DNS_NAME" ] || [ "$DNS_NAME" = "None" ]; then
          echo "Error: Could not get DNS name from CloudFormation stack"
          exit 1
        fi
        
        # Extract just the hostname from the URL
        HOSTNAME=$(echo $DNS_NAME | sed 's|https://||')
        
        echo "Testing health endpoints on: $HOSTNAME"
        
        # Health checks for frontend only (skip SSL verification)
        curl -f -k "https://$HOSTNAME/" || exit 1
        curl -f -k "https://$HOSTNAME/api/health" || exit 1

    - name: Debug deployment status
      run: |
        echo "=== Checking CloudFormation stack status ==="
        aws cloudformation describe-stacks \
          --stack-name AdminPanelStagingStack \
          --region ${{ env.AWS_REGION }} \
          --query 'Stacks[0].StackStatus' \
          --output text || echo "Stack not found"
        
        echo "=== Checking ECS service status ==="
        aws ecs describe-services \
          --cluster AdminPanelStagingStack-AdminPanelStagingStackCluster354587DC-WMnszSmI30dz \
          --services AdminPanelStagingStack-AdminPanelStagingStackService167ECF01-mGcKXTWR0Ntv \
          --region ${{ env.AWS_REGION }} \
          --query 'services[0].{status:status,desiredCount:desiredCount,runningCount:runningCount,pendingCount:pendingCount}' \
          --output table || echo "Could not check ECS status"
        
        echo "=== Checking ECS tasks ==="
        aws ecs list-tasks \
          --cluster AdminPanelStagingStack-AdminPanelStagingStackCluster354587DC-WMnszSmI30dz \
          --region ${{ env.AWS_REGION }} || echo "Could not list tasks"

    - name: Debug ECS task failures
      if: always()
      run: |
        echo "=== Checking for failed ECS tasks ==="
        TASK_ARNS=$(aws ecs list-tasks \
          --cluster AdminPanelStagingStack-AdminPanelStagingStackCluster354587DC-WMnszSmI30dz \
          --region ${{ env.AWS_REGION }} \
          --query 'taskArns' \
          --output text 2>/dev/null || echo "")
        
        if [ ! -z "$TASK_ARNS" ]; then
          echo "=== Task Details ==="
          aws ecs describe-tasks \
            --cluster AdminPanelStagingStack-AdminPanelStagingStackCluster354587DC-WMnszSmI30dz \
            --tasks $TASK_ARNS \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[].{taskArn:taskArn,lastStatus:lastStatus,desiredStatus:desiredStatus,stoppedReason:stoppedReason,healthStatus:healthStatus}' \
            --output table || echo "Could not get task details"
        else
          echo "No tasks found"
        fi

  deployment-failure:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Staging Deployment Failed
        run: |
          echo "Staging deployment failed - check the logs for details" 